
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAdmin() {
      // The admin is identified by their specific email address.
      return request.auth != null && request.auth.token.email == 'harshsingh9817@gmail.com';
    }

    function isOwner(userId) {
      // Checks if the requesting user is the owner of the document.
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isAuthenticated() {
        return request.auth != null;
    }

    // --- Public & Semi-Public Collections ---
    // Menu items, categories, and global settings should be readable by any authenticated user.
    // Only admins can make changes.
    match /menuItems/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /globals/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }

    // --- Orders Collection ---
    // Users can create orders.
    // Users can only read their own orders.
    // Admins can read all orders and update any order's status.
    match /orders/{orderId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // --- User-Specific Data ---
    // A user can read, create, and update their own profile document.
    match /users/{userId} {
      allow read, create, update: if isOwner(userId) || isAdmin();
      
      // A user can manage their own addresses sub-collection.
      match /addresses/{addressId} {
        allow read, list, create, update, delete: if isOwner(userId) || isAdmin();
      }
    }
    
    // --- Messaging and Support ---
    // Users can only read messages sent to them.
    match /adminMessages/{messageId} {
        allow read: if isOwner(resource.data.userId) || isAdmin();
        // Admins are the only ones who can create (send) messages.
        allow create: if isAdmin();
    }
    
    // Any authenticated user can create a support ticket.
    // Only admins can read all tickets and update them.
    match /supportTickets/{ticketId} {
        allow create: if isAuthenticated();
        allow read, list, update: if isAdmin();
    }
    
    // --- Coupons ---
    // Coupons can be read by any authenticated user but only managed by admins.
    match /coupons/{couponId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }
  }
}
